{{ define "workout_show_stats" }}
<canvas id="speed-elevation-chart"></canvas>

<script>
  let defaultDatasetOptions = {
    borderWidth: 2,
    pointBorderWidth: 2,
    pointRadius: 2,
    pointHitRadius: 10,
    tension: 0.5,
  };
  let chartOptions = {
    animation: false,
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
      mode: "index",
      intersect: false,
    },
    scales: {
      x: {
        type: "time",
        time: {
          unit: "minute",
          tooltipFormat: "HH:mm",
          displayFormats: { minute: "HH:mm" },
        },
      },
      y: {
        min: 0,
        ticks: {
          callback: function (value) {
            return (
              value.toLocaleString(undefined, {
                maximumFractionDigits: 2,
              }) + " {{ CurrentUser.PreferredUnits.Speed }}"
            );
          },
        },
      },
      y1: {
        position: "right",
        ticks: {
          callback: function (value) {
            return (
              value.toLocaleString(undefined, {
                maximumFractionDigits: 2,
              }) + " {{ CurrentUser.PreferredUnits.Elevation }}"
            );
          },
        },
      },
      y2: {
        display: false,
      },
      y3: {
        display: false,
      },
    },
    plugins: {
      legend: {
        display: false,
      },
      tooltip: {
        callbacks: {
          label: function (context) {
            let label = context.dataset.label || "";

            if (label) {
              label += ": ";
            }

            if (context.parsed.y !== null) {
              if (context.dataset.yAxisID === "y3") {
                label += formatDuration(context.parsed.y);
              } else {
                label += context.parsed.y.toLocaleString(undefined, {
                  maximumFractionDigits: 2,
                });

                if (context.dataset.yAxisID === "y") {
                  label += " {{ CurrentUser.PreferredUnits.Speed }}";
                  set_marker("x", context.raw.lat, context.raw.lng);
                } else if (context.dataset.yAxisID === "y1") {
                  label += " {{ CurrentUser.PreferredUnits.Elevation }}";
                } else if (context.dataset.yAxisID === "y2") {
                  label += " {{ CurrentUser.PreferredUnits.Distance }}";
                }
              }
            }
            return label;
          },
        },
      },
    },
  };
</script>

<script>
  new Chart(document.getElementById("speed-elevation-chart"), {
    type: "line",
    data: {
      datasets: [
        {
          label: "{{ i18n `Average speed` }}",
          ...defaultDatasetOptions,
          yAxisID: 'y',
          data: [
            {{ range .Items -}}
            { "x": {{ .FirstPoint.Time }}, "y": {{ .Speed | HumanSpeed }}, "lat": "{{ .FirstPoint.Lat }}", "lng": "{{ .FirstPoint.Lng }}" },
            {{- end  }}
          ],
        },
        {
          label: "{{ i18n `Elevation` }}",
          ...defaultDatasetOptions,
          yAxisID: 'y1',
          fill: true,
          data: [
            {{ range .Items -}}
            { "x": {{ .FirstPoint.Time }}, "y": {{ .FirstPoint.Elevation | HumanElevation }}, },
            {{- end  }}
          ],
        },
        {
          label: "{{ i18n `Distance` }}",
          pointStyle: false,
          borderWidth: 0,
          yAxisID: 'y2',
          data: [
            {{ range .Items -}}
            { "x": {{ .FirstPoint.Time }}, "y": {{ .TotalDistance | HumanDistance }}, },
            {{- end  }}
          ],
        },
        {
          label: "{{ i18n `Duration` }}",
          pointStyle: false,
          borderWidth: 0,
          yAxisID: 'y3',
          data: [
            {{ range .Items -}}
            { "x": {{ .FirstPoint.Time }}, "y": {{ .TotalDuration | NumericDuration }}, },
            {{- end  }}
          ],
        },
      ],
    },
    options: chartOptions,
  });
</script>

{{ end }}
